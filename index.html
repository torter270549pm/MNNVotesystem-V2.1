<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ SPU FILM - Vote System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Anuphan', sans-serif; 
            background: #020617;
            background-image: radial-gradient(at 0% 0%, rgba(30, 58, 138, 0.3) 0, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(124, 58, 237, 0.2) 0, transparent 50%);
            min-height: 100vh; color: #f8fafc;
        }
        .liquid-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2.5rem;
        }
        .btn-vote {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            box-shadow: 0 10px 20px rgba(217, 119, 6, 0.2);
        }
        input[type="range"] { appearance: none; background: rgba(255,255,255,0.1); border-radius: 1rem; height: 6px; width: 100%; outline: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 24px; height: 24px; background: #fbbf24; border-radius: 50%; border: 4px solid #0f172a; }
        
        #warning-screen { display: none; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(50px); z-index: 9999; }
        .warning-text { background: linear-gradient(to bottom, #fff, #64748b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: clamp(2rem, 8vw, 4rem); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="fixed top-6 right-6 z-[60] flex gap-2 p-1 liquid-card rounded-full px-2 py-1.5 shadow-2xl">
        <button onclick="setLanguage('th')" id="btn-th" class="px-4 py-1.5 rounded-full text-[10px] font-bold transition">TH</button>
        <button onclick="setLanguage('en')" id="btn-en" class="px-4 py-1.5 rounded-full text-[10px] font-bold transition">EN</button>
    </div>

    <div id="warning-screen" class="fixed inset-0 flex flex-col items-center justify-center text-center p-10">
        <div class="text-8xl mb-8 animate-bounce">üôè</div>
        <h1 class="warning-text font-black leading-tight mb-10">‡∏Æ‡∏±‡πà‡∏ô‡πÅ‡∏ô‡πà ‡∏Å‡∏π‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏•‡πâ‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏¥‡πà</h1>
        <button onclick="closeWarning()" class="bg-white/10 hover:bg-white/20 px-8 py-4 rounded-full text-xs font-bold tracking-widest transition uppercase">‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö / TRY AGAIN</button>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-950/90 backdrop-blur-2xl">
        <div class="liquid-card w-full max-w-sm p-12 text-center border-white/5 shadow-2xl">
            <div class="text-6xl mb-6">üé¨</div>
            <h1 id="t-welcome" class="text-3xl font-bold mb-2 uppercase tracking-tighter italic">VOTER LOGIN</h1>
            <p id="t-login-desc" class="text-slate-500 mb-10 text-[12px] tracking-[0.3em] uppercase font-black">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <input type="text" id="nickname-input" onkeyup="if(event.key === 'Enter') userLogin()" 
                   class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-center text-xl text-yellow-400 mb-8 outline-none focus:border-yellow-500/50 transition">
            <button onclick="userLogin()" id="t-login-btn" class="w-full btn-vote py-5 rounded-2xl text-black font-black uppercase tracking-widest shadow-2xl active:scale-95 transition">Enter System</button>
        </div>
    </div>

    <div id="main-content" class="max-w-xl mx-auto hidden pt-12 animate-in fade-in duration-700">
        <header class="flex justify-between items-center mb-16">
            <div>
                <p id="t-profile" class="text-yellow-500 text-[10px] font-black uppercase tracking-[0.3em] mb-1 italic"></p>
                <h2 id="display-name" class="text-3xl font-black text-white italic tracking-tighter"></h2>
            </div>
            <button onclick="userLogout()" id="t-logout" class="text-slate-500 text-[10px] font-black hover:text-red-500 transition border-b border-transparent hover:border-red-500 pb-1 uppercase"></button>
        </header>

        <div id="poll-list" class="space-y-6">
            <h3 id="t-list-title" class="text-xs font-black uppercase tracking-[0.3em] text-slate-500 mb-8"></h3>
            <div id="polls-container" class="space-y-4">
                <div class="p-8 liquid-card opacity-20 animate-pulse text-center italic text-xs">Loading...</div>
            </div>
        </div>

        <div id="vote-form" class="hidden">
            <button onclick="showPolls()" class="text-slate-500 mb-10 flex items-center text-[10px] font-black uppercase tracking-widest hover:text-white transition group">
                <span class="mr-2 group-hover:-translate-x-1 transition-transform">‚Üê</span> <span id="t-back"></span>
            </button>
            <div class="liquid-card p-10 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-yellow-500 to-orange-600"></div>
                <h2 id="poll-title" class="text-3xl font-black mb-12 text-white italic"></h2>
                <div id="criteria-container" class="space-y-12"></div>
                <button onclick="submitVotes()" id="t-submit" class="mt-16 w-full btn-vote text-black font-black py-6 rounded-3xl shadow-2xl uppercase tracking-widest text-lg transition active:scale-95"></button>
            </div>
        </div>
    </div>

    <script>
        const db = supabase.createClient('https://iiryzucuufcwkeqoxrch.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlpcnl6dWN1dWZjd2tlcW94cmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTMxOTEsImV4cCI6MjA4MzI2OTE5MX0.kDUVyPH6D8yD5flcIiMcXLpr88ecEfNXcDmdNpSTlD4');
        
        let currentLang = localStorage.getItem('lang') || 'th';
        let currentUser = localStorage.getItem('voter_name');

        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ
        const restrictedNames = ['‡∏ï‡πã‡∏≠‡∏á', '‡∏ô‡∏≠‡∏°', '‡∏™‡∏≤‡∏¢', '‡∏ï‡∏∏‡πä‡∏Å', '‡πÄ‡∏û‡∏ä‡∏£', '‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô', '‡∏≠‡πä‡∏≠‡∏î', '‡∏û‡∏¥‡∏ä‡∏ä‡∏µ‡πà'];

        const translations = {
            th: { welcome: "VOTER LOGIN", loginDesc: "SPU FILM PRODUCTION VOTE", placeholder: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...", loginBtn: "ENTER SYSTEM", profile: "VOTER NAME", logout: "LOGOUT", listTitle: "AVAILABLE PROJECTS", voted: "VOTED", notVoted: "PENDING", back: "BACK TO LIST", submit: "SUBMIT SCORE", voteBtn: "‡πÇ‡∏´‡∏ß‡∏ï / VOTE", votedAlert: "‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö", confirmAlert: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" },
            en: { welcome: "VOTER LOGIN", loginDesc: "SPU FILM PRODUCTION VOTE", placeholder: "Your nickname...", loginBtn: "ENTER SYSTEM", profile: "VOTER NAME", logout: "LOGOUT", listTitle: "AVAILABLE PROJECTS", voted: "VOTED", notVoted: "PENDING", back: "BACK TO LIST", submit: "SUBMIT SCORE", voteBtn: "VOTE", votedAlert: "Already voted", confirmAlert: "Success!" }
        };

        function setLanguage(lang) { currentLang = lang; localStorage.setItem('lang', lang); updateUI(); if (currentUser) loadPolls(); }
        
        function updateUI() {
            const t = translations[currentLang];
            document.getElementById('t-welcome').innerText = t.welcome;
            document.getElementById('t-login-desc').innerText = t.loginDesc;
            document.getElementById('nickname-input').placeholder = t.placeholder;
            document.getElementById('t-login-btn').innerText = t.loginBtn;
            document.getElementById('t-profile').innerText = t.profile;
            document.getElementById('t-logout').innerText = t.logout;
            document.getElementById('t-list-title').innerText = t.listTitle;
            document.getElementById('t-back').innerText = t.back;
            document.getElementById('t-submit').innerText = t.submit;
            document.getElementById('btn-th').className = `px-4 py-1.5 rounded-full text-[10px] font-bold ${currentLang === 'th' ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/30' : 'text-slate-500'}`;
            document.getElementById('btn-en').className = `px-4 py-1.5 rounded-full text-[10px] font-bold ${currentLang === 'en' ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/30' : 'text-slate-500'}`;
        }

        function userLogin() {
            const val = document.getElementById('nickname-input').value.trim();
            if (!val) return;
            if (restrictedNames.includes(val)) { showWarning(); return; }
            localStorage.setItem('voter_name', val);
            currentUser = val;
            checkLogin();
        }

        function showWarning() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('warning-screen').style.display = 'flex';
        }

        function closeWarning() {
            document.getElementById('warning-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('nickname-input').value = '';
        }

        function checkLogin() {
            updateUI();
            if (currentUser) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('display-name').innerText = currentUser;
                loadPolls();
            }
        }

        async function loadPolls() {
            const t = translations[currentLang];
            const container = document.getElementById('polls-container');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
            const [pRes, vRes, cRes] = await Promise.all([
                db.from('polls').select('*').order('id', { ascending: false }),
                db.from('votes').select('criteria_id').eq('voter_name', currentUser),
                db.from('criteria').select('id, poll_id')
            ]);

            const votedSet = new Set(vRes.data.map(v => v.criteria_id));
            container.innerHTML = '';

            pRes.data.forEach(p => {
                const pCritIds = cRes.data.filter(c => c.poll_id === p.id).map(c => c.id);
                const hasVoted = pCritIds.some(id => votedSet.has(id));

                container.innerHTML += `
                    <div onclick="${hasVoted ? `alert('${t.votedAlert}')` : `showVotePage(${p.id}, '${p.title}')`}" 
                         class="liquid-card p-8 flex justify-between items-center cursor-pointer group hover:bg-white/5 transition-all ${hasVoted ? 'opacity-30 grayscale pointer-events-none' : ''}">
                        <div>
                            <h4 class="text-xl font-black text-white italic group-hover:text-yellow-500 transition-colors">${p.title}</h4>
                            <p class="text-[9px] uppercase text-slate-500 tracking-[0.2em] font-black mt-1">${hasVoted ? t.voted : t.notVoted}</p>
                        </div>
                        <div class="px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest ${hasVoted ? 'bg-slate-800 text-slate-500' : 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'}">${t.voteBtn}</div>
                    </div>`;
            });
        }

        async function showVotePage(id, title) {
            document.getElementById('poll-list').classList.add('hidden');
            document.getElementById('vote-form').classList.remove('hidden');
            document.getElementById('poll-title').innerText = title;
            const { data: crit } = await db.from('criteria').select('*').eq('poll_id', id);
            const container = document.getElementById('criteria-container');
            container.innerHTML = crit.map(c => `
                <div class="space-y-6">
                    <div class="flex justify-between items-start gap-4">
                        <label class="text-slate-300 font-bold text-sm leading-relaxed">${c.label}</label>
                        <span class="text-4xl font-black text-yellow-500 italic">5</span>
                    </div>
                    <input type="range" min="1" max="10" value="5" data-id="${c.id}" oninput="this.previousElementSibling.querySelector('span').innerText = this.value">
                </div>`).join('');
        }

        async function submitVotes() {
            const sliders = document.querySelectorAll('input[type="range"]');
            const data = Array.from(sliders).map(s => ({ criteria_id: s.dataset.id, score: parseInt(s.value), voter_name: currentUser }));
            await db.from('votes').insert(data);
            alert(translations[currentLang].confirmAlert);
            location.reload();
        }

        function showPolls() { document.getElementById('poll-list').classList.remove('hidden'); document.getElementById('vote-form').classList.add('hidden'); }
        function userLogout() { localStorage.removeItem('voter_name'); location.reload(); }
        checkLogin();
    </script>
</body>
</html>

